AWSTemplateFormatVersion: 2010-09-09
Description: Deploy a Gateway Load Balancer, Check Point CloudGuard IaaS Security Gateway Auto Scaling Group, and optionally a Security Management Server, Gateway Load Balancer Endpoints and NAT Gateways for each AZ, in an existing VPC for Transit Gateway (20220314)
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: VPC Network Configuration
        Parameters:
          - VPC
          - IGWID
          - AvailabilityZones
          - NumberOfAZs
          - GatewaysSubnets
          - TgwSubnet1Id
          - TgwSubnet2Id
          - TgwSubnet3Id
          - TgwSubnet4Id
          - NatGwSubnet1CIDR
          - NatGwSubnet2CIDR
          - NatGwSubnet3CIDR
          - NatGwSubnet4CIDR
          - GWLBeSubnet1CIDR
          - GWLBeSubnet2CIDR
          - GWLBeSubnet3CIDR
          - GWLBeSubnet4CIDR
      - Label:
          default: Ingress Inspection Network Configuration
        Parameters:
          - IngressNlbSubnet1CIDR
          - IngressNlbSubnet2CIDR
          - IngressNlbSubnet3CIDR
          - IngressNlbSubnet4CIDR
          - IngressGwlbeSubnet1CIDR
          - IngressGwlbeSubnet2CIDR
          - IngressGwlbeSubnet3CIDR
          - IngressGwlbeSubnet4CIDR
      - Label:
          default: General Settings
        Parameters:
          - KeyName
          - EnableVolumeEncryption
          - VolumeSize
          - VolumeType
          - EnableInstanceConnect
          - AllowUploadDownload
          - ManagementServer
          - ConfigurationTemplate
          - AdminEmail
          - Shell
      - Label:
          default: Check Point CloudGuard IaaS Security Gateways Auto Scaling Group Configuration
        Parameters:
          - GatewayName
          - GatewayInstanceType
          - GatewaysMinSize
          - GatewaysMaxSize
          - GatewayVersion
          - GatewayPasswordHash
          - GatewaySICKey
          - ControlGatewayOverPrivateOrPublicAddress
          - CloudWatch
      - Label:
          default: Gateway Load Balancer Configuration
        Parameters:
          - GWLBName
          - TargetGroupName
          - CrossZoneLoadBalancing
      - Label:
          default: Check Point CloudGuard IaaS Security Management Server Configuration
        Parameters:
          - ManagementDeploy
          - ManagementInstanceType
          - ManagementVersion
          - ManagementPasswordHash
          - GatewaysPolicy
          - AdminCIDR
          - GatewayManagement
          - GatewaysAddresses
    ParameterLabels:
      VPC:
        default: VPC
      IGWID:
        default: Internet Gateway ID
      AvailabilityZones:
        default: Availability Zones
      NumberOfAZs:
        default: Number of AZs
      GatewaysSubnets:
        default: Gateways subnets
      TgwSubnet1Id:
        default: Transit Gateway Attachment subnet 1 Id
      TgwSubnet2Id:
        default: Transit Gateway Attachment subnet 2 Id
      TgwSubnet3Id:
        default: Transit Gateway Attachment subnet 3 Id
      TgwSubnet4Id:
        default: Transit Gateway Attachment subnet 4 Id
      NatGwSubnet1CIDR:
        default: NAT subnet 1 CIDR
      NatGwSubnet2CIDR:
        default: NAT subnet 2 CIDR
      NatGwSubnet3CIDR:
        default: NAT subnet 3 CIDR
      NatGwSubnet4CIDR:
        default: NAT subnet 4 CIDR
      GWLBeSubnet1CIDR:
        default: Gateway Load Balancer Endpoint subnet 1 CIDR
      GWLBeSubnet2CIDR:
        default: Gateway Load Balancer Endpoint subnet 2 CIDR
      GWLBeSubnet3CIDR:
        default: Gateway Load Balancer Endpoint subnet 3 CIDR
      GWLBeSubnet4CIDR:
        default: Gateway Load Balancer Endpoint subnet 4 CIDR
      KeyName:
        default: Key name
      EnableVolumeEncryption:
        default: Enable environment volume encryption
      VolumeSize:
        default: Root volume size (GB)
      VolumeType:
        default: Volume Type
      EnableInstanceConnect:
        default: Enable AWS Instance Connect
      AllowUploadDownload:
        default: Allow upload & download
      ManagementServer:
        default: Management Server
      ConfigurationTemplate:
        default: Configuration template
      AdminEmail:
        default: Email address
      Shell:
        default: Admin shell
      GatewayName:
        default: Gateways instance name
      GatewayInstanceType:
        default: Gateways instance type
      GatewaysMinSize:
        default: Minimum group size
      GatewaysMaxSize:
        default: Maximum group size
      GatewayVersion:
        default: Gateways version & license
      GatewayPasswordHash:
        default: Gateways Password hash
      GatewaySICKey:
        default: Gateways SIC key
      ControlGatewayOverPrivateOrPublicAddress:
        default: Gateways addresses
      CloudWatch:
        default: CloudWatch metrics
      GWLBName:
        default: Gateway Load Balancer Name
      TargetGroupName:
        default: Target Group Name
      CrossZoneLoadBalancing:
        default:  Enable Cross Zone Load Balancing
      ManagementDeploy:
        default: Deploy Management Server
      ManagementInstanceType:
        default: Management instance type
      ManagementVersion:
        default: Management version & license
      ManagementPasswordHash:
        default: Management password hash
      GatewaysPolicy:
        default: Security Policy
      AdminCIDR:
        default: Administrator addresses
      GatewayManagement:
        default: Manage Gateways
      GatewaysAddresses:
        default: Gateways addresses
Parameters:
  VPC:
    Description: Select an existing VPC
    Type: AWS::EC2::VPC::Id
#    MinLength: 1
    ConstraintDescription: You must select a VPC
  IGWID:
    Description: VPC's Internet Gateway Id (e.g. igw-123a4567)
    Type: String
    MinLength: 1
    ConstraintDescription: You must insert an Internet Gateway Id
  AvailabilityZones:
    Description: The Availability Zones (AZs) to use for the subnets in the VPC. Select two (the logical order is preserved)
    Type: List<AWS::EC2::AvailabilityZone::Name>
#    MinLength: 2
  NumberOfAZs:
    Description: Number of Availability Zones to use in the VPC. This must match your selections in the list of Availability Zones parameter
    Type: Number
    Default: 2
    MinValue: 2
    MaxValue: 4
  GatewaysSubnets:
    Description: Select at least 2 public subnets in the VPC. If you choose to deploy a Security Management Server it will be deployed in the first subnet
    Type: List<AWS::EC2::Subnet::Id>
#    MinLength: 2
  TgwSubnet1Id:
    Description: The TGW attachment subnet ID located in the 1st Availability Zone
    Type: String
    MinLength: 1
    ConstraintDescription: You must insert Tgw Subnet Id for Availability Zone 1
  TgwSubnet2Id:
    Description: The TGW attachment subnet ID located in the 2nd Availability Zone
    Type: String
    MinLength: 1
    ConstraintDescription: You must insert Tgw Subnet Id for Availability Zone 2
  TgwSubnet3Id:
    Description: The TGW attachment subnet ID located in the 3rd Availability Zone
    Type: String
  TgwSubnet4Id:
    Description: The TGW attachment subnet ID located in the 4th Availability Zone
    Type: String
  NatGwSubnet1CIDR:
    Description: CIDR block for NAT subnet 1 located in the 1st Availability Zone
    Type: String
    Default: 10.0.13.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  NatGwSubnet2CIDR:
    Description: CIDR block for NAT subnet 2 located in the 2nd Availability Zone
    Type: String
    Default: 10.0.23.0/24
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  NatGwSubnet3CIDR:
    Description: CIDR block for NAT subnet 3 located in the 3rd Availability Zone
    Type: String
    Default: 10.0.33.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  NatGwSubnet4CIDR:
    Description: CIDR block for NAT subnet 4 located in the 4th Availability Zone
    Type: String
    Default: 10.0.43.0/24
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  GWLBeSubnet1CIDR:
    Description: CIDR block for GWLBe subnet 1 located in the 1st Availability Zone
    Type: String
    Default: 10.0.14.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  GWLBeSubnet2CIDR:
    Description: CIDR block for GWLBe subnet 2 located in the 2nd Availability Zone
    Type: String
    Default: 10.0.24.0/24
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  GWLBeSubnet3CIDR:
    Description: CIDR block for GWLBe subnet 3 located in the 3rd Availability Zone
    Type: String
    Default: 10.0.34.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  GWLBeSubnet4CIDR:
    Description: CIDR block for GWLBe subnet 4 located in the 4th Availability Zone
    Type: String
    Default: 10.0.44.0/24
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressNlbSubnet1CIDR:
    Description: CIDR block for Ingress Nlb subnet 1 located in the 1st Availability Zone
    Type: String
    Default: 10.0.15.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressNlbSubnet2CIDR:
    Description: CIDR block for Ingress Nlb subnet 2 located in the 2nd Availability Zone
    Type: String
    Default: 10.0.25.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressNlbSubnet3CIDR:
    Description: CIDR block for Ingress Nlb subnet 3 located in the 3rd Availability Zone
    Type: String
    Default: 10.0.35.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressNlbSubnet4CIDR:
    Description: CIDR block for Ingress Nlb subnet 4 located in the 4th Availability Zone
    Type: String
    Default: 10.0.45.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressGwlbeSubnet1CIDR:
    Description: CIDR block for Ingress GWLBe subnet 1 located in the 1st Availability Zone
    Type: String
    Default: 10.0.16.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressGwlbeSubnet2CIDR:
    Description: CIDR block for Ingress GWLBe subnet 2 located in the 2nd Availability Zone
    Type: String
    Default: 10.0.26.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressGwlbeSubnet3CIDR:
    Description: CIDR block for Ingress GWLBe subnet 3 located in the 3rd Availability Zone
    Type: String
    Default: 10.0.36.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  IngressGwlbeSubnet4CIDR:
    Description: CIDR block for Ingress GWLBe subnet 4 located in the 4th Availability Zone
    Type: String
    Default: 10.0.46.0/24
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28

  KeyName:
    Description: The EC2 Key Pair to allow SSH access to the instances created by this stack
    Type: AWS::EC2::KeyPair::KeyName
#    MinLength: 1
    ConstraintDescription: Must be the name of an existing EC2 KeyPair
  EnableVolumeEncryption:
    Description: Encrypt Environment instances volume with default AWS KMS key
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
  VolumeSize:
    Type: Number
    MinValue: 100
    Default: 100
  VolumeType:
    Description: General Purpose SSD Volume Type
    Type: String
    Default: gp3
    AllowedValues:
      - gp3
      - gp2
  EnableInstanceConnect:
    Description: Enable SSH connection over AWS web console
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
  AllowUploadDownload:
    Description: Automatically download Blade Contracts and other important data. Improve product experience by sending data to Check Point
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
  ManagementServer:
    Description: The name that represents the Security Management Server in the automatic provisioning configuration
    Type: String
    Default: gwlb-management-server
    MinLength: 1
  ConfigurationTemplate:
    Description: A name of a gateway configuration template in the automatic provisioning configuration
    Type: String
    Default: gwlb-ASG-configuration
    MinLength: 1
  AdminEmail:
    Description: Notifications about scaling events will be sent to this email address (optional)
    Type: String
    Default: ''
    AllowedPattern: '^(([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?))?$'
  Shell:
    Description: Change the admin shell to enable advanced command line configuration. Applies for Security Gateways and Security Management Server if deployed.
    Type: String
    Default: /etc/cli.sh
    AllowedValues:
      - /etc/cli.sh
      - /bin/bash
      - /bin/csh
      - /bin/tcsh
  GatewayName:
    Description: The name tag of the Security Gateway instances (optional)
    Type: String
    Default: Check-Point-Gateway
  GatewayInstanceType:
    Description: The EC2 instance type for the Security Gateways
    Type: String
    Default: c5.xlarge
    AllowedValues:
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5.18xlarge
      - c5n.large
      - c5n.xlarge
      - c5n.2xlarge
      - c5n.4xlarge
      - c5n.9xlarge
      - c5n.18xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  GatewaysMinSize:
    Description: The minimal number of Security Gateways
    Type: Number
    Default: 2
    MinValue: 1
  GatewaysMaxSize:
    Description: The maximal number of Security Gateways
    Type: Number
    Default: 10
    MinValue: 1
  GatewayVersion:
    Description: The version and license to install on the Security Gateways
    Type: String
    Default: R80.40-BYOL
    AllowedValues:
      - R80.40-BYOL
      - R80.40-PAYG-NGTP
      - R80.40-PAYG-NGTX
      - R80.40-BYOL-WorkshopVersion
  GatewayPasswordHash:
    Description: Admin user's password hash (use command "openssl passwd -6 PASSWORD" to get the PASSWORD's hash) (optional)
    Type: String
    Default: ''
    AllowedPattern: '^[\$\./a-zA-Z0-9]*$'
    NoEcho: true
  GatewaySICKey:
    Description: The Secure Internal Communication key creates trusted connections between Check Point components. Choose a random string consisting of at least 8 alphanumeric characters
    Type: String
    AllowedPattern: '^[a-zA-Z0-9]{8,}$'
    ConstraintDescription: Secure Internal Communication activation key should contain only alpha numeric characters and be at least 8 characters long
    NoEcho: true
  ControlGatewayOverPrivateOrPublicAddress:
    Description: Determines if the gateways are provisioned using their private or public address
    Type: String
    Default: private
    AllowedValues:
      - private
      - public
  CloudWatch:
    Description: Report Check Point specific CloudWatch metrics
    Type: String
    Default: false
    AllowedValues:
      - true
      - false
  GWLBName:
    Description: Gateway Load Balancer name. This name must be unique within your AWS account and can have a maximum of 32 alphanumeric characters and hyphens. A name cannot begin or end with a hyphen.
    Type: String
    Default: gwlb1
    ConstraintDescription: Must be a valid GWLB Name
  TargetGroupName:
    Description: Target Group Name. This name must be unique within your AWS account and can have a maximum of 32 alphanumeric characters and hyphens. A name cannot begin or end with a hyphen.
    Type: String
    Default: tg1
    ConstraintDescription: Must be a valid target group name
  CrossZoneLoadBalancing:
    Description: Select 'true' to enable cross-az load balancing. NOTE! this may cause a spike in cross-az charges.
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
  ManagementDeploy:
    Description: Select 'false' to use an existing Security Management Server or to deploy one later and to ignore the other parameters of this section
    Type: String
    Default: true
    AllowedValues:
      - true
      - false
  ManagementInstanceType:
    Description: The EC2 instance type of the Security Management Server
    Type: String
    Default: m5.xlarge
    AllowedValues:
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.12xlarge
      - m5.24xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  ManagementVersion:
    Description: The license to install on the Security Management Server
    Type: String
    Default: R81.10-BYOL-WorkshopVersion
    AllowedValues:
      - R80.40-BYOL
      - R80.40-PAYG
      - R81-BYOL
      - R81-PAYG
      - R81.10-BYOL
      - R81.10-PAYG
      - R81.10-BYOL-WorkshopVersion
  ManagementPasswordHash:
    Description: Admin user's password hash (use command "openssl passwd -6 PASSWORD" to get the PASSWORD's hash) (optional)
    Type: String
    Default: ''
    AllowedPattern: '^[\$\./a-zA-Z0-9]*$'
    NoEcho: true
  GatewaysPolicy:
    Description: The name of the Security Policy package to be installed on the gateways in the Security Gateways Auto Scaling group
    Type: String
    Default: Standard
    MinLength: 1
  AdminCIDR:
    Description: Allow web, SSH, and graphical clients only from this network to communicate with the Security Management Server
    Type: String
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
  GatewayManagement:
    Description: Select 'Over the internet' if any of the gateways you wish to manage are not directly accessed via their private IP address
    Type: String
    Default: Locally managed
    AllowedValues:
      - Locally managed
      - Over the internet
  GatewaysAddresses:
    Description: Allow gateways only from this network to communicate with the Security Management Server
    Type: String
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
  SpokeCIDR:
    Type: String
    Default: 10.100.0.0/16
    AllowedPattern: '^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  PubRT:
    Type: String
    ConstraintDescription: You must select a VPC
Conditions:
  4AZs: !Equals [!Ref NumberOfAZs, 4]
  3AZs: !Or [!Equals [!Ref NumberOfAZs, 3], !Condition 4AZs]
  DeployManagement: !Equals [!Ref ManagementDeploy, true]
#  VolumeEncryption: !Equals [!Ref EnableVolumeEncryption, true]
Resources:

### Centralized GWLBE Subnets
  GWLBeSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref GWLBeSubnet1CIDR
      AvailabilityZone: !Select [0, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: GWLBe subnet 1
        - Key: Network
          Value: Private
  GWLBeSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref GWLBeSubnet2CIDR
      AvailabilityZone: !Select [1, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: GWLBe subnet 2
        - Key: Network
          Value: Private
  GWLBeSubnet3:
    Type: AWS::EC2::Subnet
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref GWLBeSubnet3CIDR
      AvailabilityZone: !Select [2, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: GWLBe subnet 3
        - Key: Network
          Value: Private
  GWLBeSubnet4:
    Type: AWS::EC2::Subnet
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref GWLBeSubnet4CIDR
      AvailabilityZone: !Select [3, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: GWLBe subnet 4
        - Key: Network
          Value: Private
### Centralized GWLBES RT + Routes
  GWLBeSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: GWLBe Subnet 1 Route Table
        - Key: Network
          Value: Private
  GWLBeSubnet1NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1
      RouteTableId: !Ref GWLBeSubnet1RouteTable
  GWLBeSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref GWLBeSubnet1RouteTable
      SubnetId: !Ref GWLBeSubnet1
  GWLBeSubnet2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: GWLBe Subnet 2 Route Table
        - Key: Network
          Value: Private
  GWLBeSubnet2NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway2
      RouteTableId: !Ref GWLBeSubnet2RouteTable
  GWLBeSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref GWLBeSubnet2RouteTable
      SubnetId: !Ref GWLBeSubnet2
  GWLBeSubnet3RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: GWLBe Subnet 3 Route Table
        - Key: Network
          Value: Private
  GWLBeSubnet3NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway3
      RouteTableId: !Ref GWLBeSubnet3RouteTable
  GWLBeSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 3AZs
    Properties:
      RouteTableId: !Ref GWLBeSubnet3RouteTable
      SubnetId: !Ref GWLBeSubnet3
  GWLBeSubnet4RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: GWLBe Subnet 4 Route Table
        - Key: Network
          Value: Private
  GWLBeSubnet4NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway4
      RouteTableId: !Ref GWLBeSubnet4RouteTable
  GWLBeSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 4AZs
    Properties:
      RouteTableId: !Ref GWLBeSubnet4RouteTable
      SubnetId: !Ref GWLBeSubnet4

### NAT GW Subnets
  NatGwSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref NatGwSubnet1CIDR
      AvailabilityZone: !Select [0, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: NAT subnet 1
        - Key: Network
          Value: Private
  NatGwSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref NatGwSubnet2CIDR
      AvailabilityZone: !Select [1, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: NAT subnet 2
        - Key: Network
          Value: Private
  NatGwSubnet3:
    Type: AWS::EC2::Subnet
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref NatGwSubnet3CIDR
      AvailabilityZone: !Select [2, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: NAT subnet 3
        - Key: Network
          Value: Private
  NatGwSubnet4:
    Type: AWS::EC2::Subnet
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref NatGwSubnet4CIDR
      AvailabilityZone: !Select [3, !Ref AvailabilityZones]
      Tags:
        - Key: Name
          Value: NAT subnet 4
        - Key: Network
          Value: Private

### NAT GW RT + Routes
  NatGwSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: NAT Subnet 1 Route Table
        - Key: Network
          Value: Public
  NatGwSubnet1NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGWID
      RouteTableId: !Ref NatGwSubnet1RouteTable
  NatGwSubnet1SpokeCIDRRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref SpokeCIDR
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref NatGwSubnet1RouteTable
  NatGwSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref NatGwSubnet1RouteTable
      SubnetId: !Ref NatGwSubnet1
  NatGwSubnet2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: NAT Subnet 2 Route Table
        - Key: Network
          Value: Public
  NatGwSubnet2NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGWID
      RouteTableId: !Ref NatGwSubnet2RouteTable
  NatGwSubnet2SpokeCIDRRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref SpokeCIDR
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref NatGwSubnet2RouteTable
  NatGwSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref NatGwSubnet2RouteTable
      SubnetId: !Ref NatGwSubnet2
  NatGwSubnet3RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: NAT Subnet 3 Route Table
        - Key: Network
          Value: Public
  NatGwSubnet3NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGWID
      RouteTableId: !Ref NatGwSubnet3RouteTable
  NatGwSubnet3SpokeCIDRRoute:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref SpokeCIDR
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref NatGwSubnet3RouteTable
  NatGwSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 3AZs
    Properties:
      RouteTableId: !Ref NatGwSubnet3RouteTable
      SubnetId: !Ref NatGwSubnet3
  NatGwSubnet4RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: NAT Subnet 4 Route Table
        - Key: Network
          Value: Public
  NatGwSubnet4NatGwDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref IGWID
      RouteTableId: !Ref NatGwSubnet4RouteTable
  NatGwSubnet4SpokeCIDRRoute:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref SpokeCIDR
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref NatGwSubnet4RouteTable
  NatGwSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 4AZs
    Properties:
      RouteTableId: !Ref NatGwSubnet4RouteTable
      SubnetId: !Ref NatGwSubnet4
### Subnets for Ingress NLB & GWLEB

  Sub01IngressNlb:
    Type: "AWS::EC2::Subnet"
    Properties:
        CidrBlock: !Ref IngressNlbSubnet1CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub01-ingress-Nlb", !Ref AWS::StackName]]
  Sub02IngressNlb:
    Type: "AWS::EC2::Subnet"
    Properties:
        CidrBlock: !Ref IngressNlbSubnet2CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub02-ingress-Nlb", !Ref AWS::StackName]]
  Sub03IngressNlb:
    Type: "AWS::EC2::Subnet"
    Condition: 3AZs
    Properties:
        CidrBlock: !Ref IngressNlbSubnet3CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [2, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub03-ingress-Nlb", !Ref AWS::StackName]]
  Sub04IngressNlb:
    Type: "AWS::EC2::Subnet"
    Condition: 4AZs
    Properties:
        CidrBlock: !Ref IngressNlbSubnet4CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [3, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub04-ingress-Nlb", !Ref AWS::StackName]]
  Sub01IngressGwlbe:
    Type: "AWS::EC2::Subnet"
    Properties:
        CidrBlock: !Ref IngressGwlbeSubnet1CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [0, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub01-ingress-Gwlbe", !Ref AWS::StackName]]
  Sub02IngressGwlbe:
    Type: "AWS::EC2::Subnet"
    Properties:
        CidrBlock: !Ref IngressGwlbeSubnet2CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [1, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub02-ingress-Gwlbe", !Ref AWS::StackName]]
  Sub03IngressGwlbe:
    Type: "AWS::EC2::Subnet"
    Condition: 3AZs
    Properties:
        CidrBlock: !Ref IngressGwlbeSubnet3CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [2, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub03-ingress-Gwlbe", !Ref AWS::StackName]]
  Sub04IngressGwlbe:
    Type: "AWS::EC2::Subnet"
    Condition: 4AZs
    Properties:
        CidrBlock: !Ref IngressGwlbeSubnet4CIDR
        VpcId: !Ref VPC
        AvailabilityZone: !Select [3, !Ref AvailabilityZones]
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["sub04-ingress-Gwlbe", !Ref AWS::StackName]]

### GWLBE for Ingress
  IngressGWLBE01:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref Sub01IngressGwlbe
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  IngressGWLBE02:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref Sub02IngressGwlbe
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  IngressGWLBE03:
    Type: AWS::EC2::VPCEndpoint
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref Sub03IngressGwlbe
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  IngressGWLBE04:
    Type: AWS::EC2::VPCEndpoint
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref Sub04IngressGwlbe
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName

### RT for Ingress Subnets

  IGWIngressRT:
    Type: "AWS::EC2::RouteTable"
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: "Name"
          Value: !Join [ "-", [ "IGW-ingress-RT", !Ref AWS::StackName ] ]

  IngressNlbRT01:
    Type: "AWS::EC2::RouteTable"
    Properties:
        VpcId: !Ref VPC
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["ingress-Nlb01-RT", !Ref AWS::StackName]]
  IngressNlbRT02:
    Type: "AWS::EC2::RouteTable"
    Properties:
        VpcId: !Ref VPC
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["ingress-Nlb02-RT", !Ref AWS::StackName]]
  IngressNlbRT03:
    Type: "AWS::EC2::RouteTable"
    Condition: 3AZs
    Properties:
        VpcId: !Ref VPC
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["ingress-Nlb03-RT", !Ref AWS::StackName]]
  IngressNlbRT04:
    Type: "AWS::EC2::RouteTable"
    Condition: 4AZs
    Properties:
        VpcId: !Ref VPC
        Tags:
          -
            Key: "Name"
            Value: !Join [ "-", ["ingress-Nlb01-R4", !Ref AWS::StackName]]
            
### Ingress NLB RT Associations
  IGWIngressRTAssociation:
    Type: "AWS::EC2::GatewayRouteTableAssociation"
    Properties:
      RouteTableId: !Ref IGWIngressRT
      GatewayId: !Ref IGWID

  Sub01IngressNlbRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
        RouteTableId: !Ref IngressNlbRT01
        SubnetId: !Ref Sub01IngressNlb
  Sub02IngressNlbRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
        RouteTableId: !Ref IngressNlbRT02
        SubnetId: !Ref Sub02IngressNlb
  Sub03IngressNlbRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: 3AZs
    Properties:
        RouteTableId: !Ref IngressNlbRT03
        SubnetId: !Ref Sub03IngressNlb
  Sub04IngressNlbRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: 4AZs
    Properties:
        RouteTableId: !Ref IngressNlbRT04
        SubnetId: !Ref Sub04IngressNlb

### Ingress GWLBe RT Association
  Sub01IngressGwlbeRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Sub01IngressGwlbe
  Sub02IngressGwlbeRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Sub02IngressGwlbe
  Sub03IngressGwlbeRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: 3AZs
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Sub03IngressGwlbe
  Sub04IngressGwlbeRTAssociation:
    Type: "AWS::EC2::SubnetRouteTableAssociation"
    Condition: 4AZs
    Properties:
      RouteTableId: !Ref PubRT
      SubnetId: !Ref Sub04IngressGwlbe

### Subnet Routes for Ingress IGW --> GWLBeFirst Ingress

  IngressIGWGwlbe01Route:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: !Ref IngressNlbSubnet1CIDR
      RouteTableId: !Ref IGWIngressRT
      VpcEndpointId: !Ref IngressGWLBE01

  IngressIGWGwlbe02Route:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: !Ref IngressNlbSubnet2CIDR
      RouteTableId: !Ref IGWIngressRT
      VpcEndpointId: !Ref IngressGWLBE02
  IngressIGWGwlbe03Route:
    Type: "AWS::EC2::Route"
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref IngressNlbSubnet3CIDR
      RouteTableId: !Ref IGWIngressRT
      VpcEndpointId: !Ref IngressGWLBE03
  IngressIGWGwlbe04Route:
    Type: "AWS::EC2::Route"
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref IngressNlbSubnet4CIDR
      RouteTableId: !Ref IGWIngressRT
      VpcEndpointId: !Ref IngressGWLBE04

### Subnet Routes for Ingress GWLBeFirst RT
  Sub01IngressNlbDefaultRoute:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref IngressNlbRT01
      VpcEndpointId: !Ref IngressGWLBE01
  Sub02IngressNlbDefaultRoute:
    Type: "AWS::EC2::Route"
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref IngressNlbRT02
      VpcEndpointId: !Ref IngressGWLBE02
  Sub03IngressNlbDefaultRoute:
    Type: "AWS::EC2::Route"
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref IngressNlbRT03
      VpcEndpointId: !Ref IngressGWLBE03
  Sub04IngressNlbDefaultRoute:
    Type: "AWS::EC2::Route"
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      RouteTableId: !Ref IngressNlbRT04
      VpcEndpointId: !Ref IngressGWLBE04

### GWLB Stack: GWLB & CGNS ASG
  GWLBStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://chkp-gwlb-workshop.s3.us-west-2.amazonaws.com/gwlb.yaml
      Parameters:
        VPC: !Ref VPC
        GatewaysSubnets: !Join [',', !Ref GatewaysSubnets]
        KeyName: !Ref KeyName
        EnableVolumeEncryption: !Ref EnableVolumeEncryption
        VolumeType: !Ref VolumeType
        VolumeSize: !Ref VolumeSize
        EnableInstanceConnect: !Ref EnableInstanceConnect
        AllowUploadDownload: !Ref AllowUploadDownload
        ManagementServer: !Ref ManagementServer
        ConfigurationTemplate: !Ref ConfigurationTemplate
        AdminEmail: !Ref AdminEmail
        Shell: !Ref Shell
        GWLBName: !Ref GWLBName
        TargetGroupName: !Ref TargetGroupName
        AcceptConnectionRequired: false
        CrossZoneLoadBalancing: !Ref CrossZoneLoadBalancing
        GatewayName: !Ref GatewayName
        GatewayInstanceType: !Ref GatewayInstanceType
        GatewaysMinSize: !Ref GatewaysMinSize
        GatewaysMaxSize: !Ref GatewaysMaxSize
        GatewayVersion: !Ref GatewayVersion
        GatewayPasswordHash: !Ref GatewayPasswordHash
        GatewaySICKey: !Ref GatewaySICKey
        ControlGatewayOverPrivateOrPublicAddress: !Ref ControlGatewayOverPrivateOrPublicAddress
        CloudWatch: !Ref CloudWatch
        ManagementDeploy: !Ref ManagementDeploy
        ManagementInstanceType: !Ref ManagementInstanceType
        ManagementVersion: !Ref ManagementVersion
        ManagementPasswordHash: !Ref ManagementPasswordHash
        GatewaysPolicy: !Ref GatewaysPolicy
        AdminCIDR: !Ref AdminCIDR
        GatewayManagement: !Ref GatewayManagement
        GatewaysAddresses: !Ref GatewaysAddresses

### GWLBE for Centralized Inspection (E/W/N/S)
  GWLBe1:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref GWLBeSubnet1
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  GWLBe2:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref GWLBeSubnet2
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  GWLBe3:
    Type: AWS::EC2::VPCEndpoint
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref GWLBeSubnet3
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName
  GWLBe4:
    Type: AWS::EC2::VPCEndpoint
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      VpcEndpointType: GatewayLoadBalancer
      SubnetIds:
        - !Ref GWLBeSubnet4
      ServiceName: !GetAtt GWLBStack.Outputs.GWLBServiceName

### TGW Attachment Subnet 1 RT + Routes
  TGWAttachmentSubnet1RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: TGW Attachment Subnet 1 Route Table
        - Key: Network
          Value: Private
  TGWAttachmentSubnet1GWLBeDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable
  TGWAttachmentSubnet1NLB1Route:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet1CIDR
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable
  TGWAttachmentSubnet1NLB2Route:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet2CIDR
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable
  TGWAttachmentSubnet1NLB3Route:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet3CIDR
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable
  TGWAttachmentSubnet1NLB4Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet4CIDR
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable

  TGWAttachmentSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TGWAttachmentSubnet1RouteTable
      SubnetId: !Ref TgwSubnet1Id

### TGW Attachment Subnet 2 RT + Routes
  TGWAttachmentSubnet2RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: TGW Attachment Subnet 2 Route Table
        - Key: Network
          Value: Private
  TGWAttachmentSubnet2GWLBeDefaultRoute:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
  TGWAttachmentSubnet2NLB1Route:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet1CIDR
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
  TGWAttachmentSubnet2NLB2Route:
    Type: AWS::EC2::Route
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet2CIDR
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
  TGWAttachmentSubnet2NLB3Route:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet3CIDR
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
  TGWAttachmentSubnet2NLB4Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet4CIDR
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
  TGWAttachmentSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref TGWAttachmentSubnet2RouteTable
      SubnetId: !Ref TgwSubnet2Id

### TGW Attachment Subnet 3 RT + Routes
  TGWAttachmentSubnet3RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 3AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: TGW Attachment Subnet 3 Route Table
        - Key: Network
          Value: Private
  TGWAttachmentSubnet3GWLBeDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
  TGWAttachmentSubnet3NLB1Route:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet1CIDR
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
  TGWAttachmentSubnet3NLB2Route:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet2CIDR
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
  TGWAttachmentSubnet3NLB3Route:
    Type: AWS::EC2::Route
    Condition: 3AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet3CIDR
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
  TGWAttachmentSubnet3NLB4Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet4CIDR
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
  TGWAttachmentSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 3AZs
    Properties:
      RouteTableId: !Ref TGWAttachmentSubnet3RouteTable
      SubnetId: !Ref TgwSubnet3Id

### TGW Attachment Subnet 4 RT + Routes
  TGWAttachmentSubnet4RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: 4AZs
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: TGW Attachment Subnet 4 Route Table
        - Key: Network
          Value: Private
  TGWAttachmentSubnet4GWLBeDefaultRoute:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
  TGWAttachmentSubnet4NLB1Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet1CIDR
      VpcEndpointId: !Ref GWLBe1
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
  TGWAttachmentSubnet4NLB2Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet2CIDR
      VpcEndpointId: !Ref GWLBe2
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
  TGWAttachmentSubnet4NLB3Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet3CIDR
      VpcEndpointId: !Ref GWLBe3
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
  TGWAttachmentSubnet4NLB4Route:
    Type: AWS::EC2::Route
    Condition: 4AZs
    Properties:
      DestinationCidrBlock: !Ref NatGwSubnet4CIDR
      VpcEndpointId: !Ref GWLBe4
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
  TGWAttachmentSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: 4AZs
    Properties:
      RouteTableId: !Ref TGWAttachmentSubnet4RouteTable
      SubnetId: !Ref TgwSubnet4Id

### NATGW & Public IP's
  NatGwPublicAddress1:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NatGwPublicAddress2:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  NatGwPublicAddress3:
    Type: AWS::EC2::EIP
    Condition: 3AZs
    Properties:
      Domain: vpc
  NatGwPublicAddress4:
    Type: AWS::EC2::EIP
    Condition: 4AZs
    Properties:
      Domain: vpc
  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGwPublicAddress1.AllocationId
      SubnetId: !Ref NatGwSubnet1
      Tags:
        - Key: Name
          Value: NatGW1
  NatGateway2:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGwPublicAddress2.AllocationId
      SubnetId: !Ref NatGwSubnet2
      Tags:
        - Key: Name
          Value: NatGW2
  NatGateway3:
    Type: AWS::EC2::NatGateway
    Condition: 3AZs
    Properties:
      AllocationId: !GetAtt NatGwPublicAddress3.AllocationId
      SubnetId: !Ref NatGwSubnet3
      Tags:
        - Key: Name
          Value: NatGW3
  NatGateway4:
    Type: AWS::EC2::NatGateway
    Condition: 4AZs
    Properties:
      AllocationId: !GetAtt NatGwPublicAddress4.AllocationId
      SubnetId: !Ref NatGwSubnet4
      Tags:
        - Key: Name
          Value: NatGW4


Outputs:
  ManagementPublicAddress:
    Description: The public address of the management server
    Value: !GetAtt GWLBStack.Outputs.ManagementPublicAddress
    Condition: DeployManagement
  ConfigurationTemplateName:
    Description: The name that represents the configuration template. Configurations required to automatically provision the Gateways in the Auto Scaling Group, such as what Security Policy to install and which Blades to enable, will be placed under this template name
    Value: !GetAtt GWLBStack.Outputs.ConfigurationTemplateName
  ControllerName:
    Description: The name that represents the controller. Configurations required to connect to your AWS environment, such as credentials and regions, will be placed under this controller name
    Value: !GetAtt GWLBStack.Outputs.ControllerName
  GWLBName:
    Description: Gateway Load Balancer Name
    Value: !Ref GWLBName
  GWLBServiceName:
    Description: Gateway Load Balancer Service Name
    Value: !GetAtt GWLBStack.Outputs.GWLBServiceName
  GWLBeSubnet1RouteTable:
    Description: GWLBe1 RT
    Value: !Ref GWLBeSubnet1RouteTable
  GWLBeSubnet2RouteTable:
    Description: GWLBe2 RT
    Value: !Ref GWLBeSubnet2RouteTable
  GWLBeSubnet3RouteTable:
    Description: GWLBe3 RT
    Value: !Ref GWLBeSubnet3RouteTable
    Condition: 3AZs
  GWLBeSubnet4RouteTable:
    Description: GWLBe4 RT
    Value: !Ref GWLBeSubnet4RouteTable
    Condition: 4AZs
  NatGwSubnet1:
    Description: NAT GW Subnet1
    Value: !Ref NatGwSubnet1
  NatGwSubnet2:
    Description: NAT GW Subnet2
    Value: !Ref NatGwSubnet2
  NatGwSubnet3:
    Description: NAT GW Subnet3
    Value: !Ref NatGwSubnet3
    Condition: 3AZs
  NatGwSubnet4:
    Description: NAT GW Subnet4
    Value: !Ref NatGwSubnet4
    Condition: 4AZs
  Sub01IngressNlb:
    Description: Ingress Nlb Subnet1
    Value: !Ref Sub01IngressNlb
  Sub02IngressNlb:
    Description: Ingress Nlb Subnet2
    Value: !Ref Sub02IngressNlb
  Sub03IngressNlb:
    Description: Ingress Nlb Subnet3
    Value: !Ref Sub03IngressNlb
    Condition: 3AZs
  Sub04IngressNlb:
    Description: Ingress Nlb Subnet4
    Value: !Ref Sub04IngressNlb
    Condition: 4AZs
  IngressNlbRT01:
    Description: Ingress GWLB RT01
    Value: !Ref IngressNlbRT01
  IngressNlbRT02:
    Description: Ingress GWLB RT02
    Value: !Ref IngressNlbRT02
  IngressNlbRT03:
    Description: Ingress GWLB RT03
    Value: !Ref IngressNlbRT03
    Condition: 3AZs
  IngressNlbRT04:
    Description: Ingress GWLB RT04
    Value: !Ref IngressNlbRT04
    Condition: 4AZs
